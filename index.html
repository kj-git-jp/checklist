<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チェックリスト</title>
  <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #f2f2f7;
      margin: 0;
    }

    h2 {
      padding: 14px 16px;
      margin: 0;
      font-size: 20px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .lists {
      display: flex;
      gap: 8px;
      padding: 10px;
      overflow-x: auto;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .lists button {
      padding: 6px 12px;
      border-radius: 14px;
      border: none;
      background: #e5e5ea;
      font-size: 14px;
      white-space: nowrap;
    }

    .lists .active {
      background: #007aff;
      color: #fff;
    }

    .add-list {
      background: #34c759;
      color: #fff;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .toolbar button {
      flex: 1;
      background: #8e8e93;
    }

    .input-area {
      display: flex;
      gap: 6px;
      padding: 12px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    input[type="text"], input[type="date"] {
      padding: 10px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    ul { margin: 0; padding: 0; }

    li {
      list-style: none;
      padding: 14px 16px;
      background: #fff;
      border-bottom: 1px solid #e5e5ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px; /* 少し小さく */
    }

    .text {
      display: flex;
      flex-direction: column;
      gap: 2px;     /* 行間を少し詰める */
    }

    .overdue {
      color: #ff3b30;
      font-weight: 600;
    }

    .done {
      color: #8e8e93;
      text-decoration: line-through;
    }

    .delete {
      background: none;
      border: none;
      font-size: 16px;
      color: #ff3b30;
    }

    .text input[type="date"] {
      font-size: 13px;      /* 期限だけ小さく */
      padding: 2px 0;       /* 余白を減らす */
      line-height: 1.2;
    }

    @media (prefers-color-scheme: dark) {
      body { background: #000; color: #fff; }
      h2, .lists, .toolbar, .input-area, li { background: #1c1c1e; }
      li { border-bottom: 1px solid #2c2c2e; }
      input[type="text"], input[type="date"] {
        background: #2c2c2e;
        color: #fff;
        border: 1px solid #3a3a3c;
      }
    }
  </style>
</head>
<body>

<h2 id="title">チェックリスト</h2>

<div class="lists" id="lists"></div>

<div class="toolbar">
  <button onclick="backup()">バックアップ</button>
  <button onclick="restore()">復元</button>
  <button onclick="restoreAutoBackup()">自動復元</button>
</div>

<div class="input-area">
  <input id="itemInput" placeholder="新しい項目">
  <input id="dateInput" type="date">
  <button onclick="addItem()">追加</button>
</div>

<ul id="items"></ul>

<input id="fileInput" type="file" accept="application/json" style="display:none">

<script>
  let currentList = localStorage.getItem("currentList") || "default";

  function getLists() {
    return JSON.parse(localStorage.getItem("lists")) || {
      default: { name: "メイン", items: [] }
    };
  }

  function saveLists(lists) {
    localStorage.setItem("lists", JSON.stringify(lists));
  }

  function backup() {
      alert(
      "バックアップファイルを保存します。\n\n" +
      "次の画面で必ず\n「ファイルに保存」→ iCloud Drive\nを選んでください。"
      );

      const data = {
        lists: getLists(),
        currentList: currentList
      };

      const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: "application/json" }
      );

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download =
        "checklist-backup-" +
        new Date().toISOString().split("T")[0] +
        ".json";

      a.click();
  }

  function restore() {
    if (!confirm("現在のデータは上書きされます。続行しますか？")) return;
    document.getElementById("fileInput").click();
  }

  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        localStorage.setItem("lists", JSON.stringify(data.lists));
        localStorage.setItem("currentList", data.currentList || "default");
        location.reload();
      } catch {
        alert("復元に失敗しました");
      }
    };
    reader.readAsText(file);
  });

  function isOverdue(date) {
    if (!date) return false;
    const today = new Date().toISOString().split("T")[0];
    return date < today;
  }

  function renderLists() {
    const lists = getLists();
    const container = document.getElementById("lists");
    container.innerHTML = "";

    Object.keys(lists).forEach(id => {
      const btn = document.createElement("button");
      btn.textContent = lists[id].name;
      if (id === currentList) btn.classList.add("active");
      btn.onclick = () => {
        currentList = id;
        localStorage.setItem("currentList", id);
        render();
      };
      container.appendChild(btn);
    });

    const add = document.createElement("button");
    add.textContent = "＋";
    add.className = "add-list";
    add.onclick = () => {
      const name = prompt("リスト名");
      if (!name) return;
      const id = Date.now();
      const lists = getLists();
      lists[id] = { name, items: [] };
      saveLists(lists);
      currentList = id;
      localStorage.setItem("currentList", id);
      render();
    };
    container.appendChild(add);
  }

  function render() {
    const lists = getLists();
    const list = lists[currentList];
    if (!list) return;

    document.getElementById("title").textContent = list.name;

    list.items.sort((a, b) => {
      if (a.done !== b.done) return a.done - b.done;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return a.date.localeCompare(b.date);
    });

    const ul = document.getElementById("items");
    ul.innerHTML = "";

    list.items.forEach(item => {
      const overdue = isOverdue(item.date) && !item.done;

      const li = document.createElement("li");
      li.innerHTML = `
        <div class="left">
          <input type="checkbox" ${item.done ? "checked" : ""}>
          <div class="text">
            <span class="${item.done ? "done" : ""}">${item.text}</span>
            <input type="date" value="${item.date || ""}" class="${overdue ? "overdue" : ""}">
          </div>
        </div>
        <button class="delete">削除</button>
      `;

      li.querySelector("input[type=checkbox]").onchange = () => {
        item.done = !item.done;
        saveLists(lists);
        render();
      };

      li.querySelector("input[type=date]").onchange = e => {
        item.date = e.target.value;
        saveLists(lists);
        render();
      };

      li.querySelector(".delete").onclick = () => {
        list.items = list.items.filter(i => i.id !== item.id);
        saveLists(lists);
        render();
      };

      ul.appendChild(li);
    });

    renderLists();
  }

  function addItem() {
    if (!itemInput.value) return;
    const lists = getLists();
    lists[currentList].items.push({
      id: Date.now(),
      text: itemInput.value,
      date: dateInput.value,
      done: false
    });
    saveLists(lists);
    itemInput.value = "";
    dateInput.value = "";

    /* フォーカスを外す（重要） */
    itemInput.blur();
    dateInput.blur();

    render();
  }

  function autoBackup() {
      const data = {
        lists: getLists(),
        currentList: currentList,
        savedAt: new Date().toISOString()
      };

      localStorage.setItem("autoBackup", JSON.stringify(data));
  }

  function restoreAutoBackup() {
      const backup = localStorage.getItem("autoBackup");
      if (!backup) {
        alert("自動バックアップはありません");
        return;
      }

      if (!confirm("自動バックアップから復元しますか？\n現在のデータは上書きされます。")) {
        return;
      }

      const data = JSON.parse(backup);
      localStorage.setItem("lists", JSON.stringify(data.lists));
      localStorage.setItem("currentList", data.currentList || "default");
      location.reload();
  }
  
  autoBackup();
  render();
</script>

</body>
</html>
