<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チェックリスト</title>

  <!-- iOSズーム防止 -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #f2f2f7;
      margin: 0;
    }

    h2 {
      padding: 14px 16px;
      margin: 0;
      font-size: 20px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .lists {
      display: flex;
      gap: 8px;
      padding: 10px;
      overflow-x: auto;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .lists button {
      padding: 6px 12px;
      border-radius: 14px;
      border: none;
      background: #e5e5ea;
      font-size: 14px;
      white-space: nowrap;
    }

    .lists .active {
      background: #007aff;
      color: #fff;
    }

    .add-list {
      background: #34c759;
      color: #fff;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .toolbar button {
      flex: 1;
      background: #8e8e93;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px;
    }

    .input-area {
      display: flex;
      gap: 6px;
      padding: 12px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    input[type="text"], input[type="date"] {
      padding: 10px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    ul { margin: 0; padding: 0; }

    li {
      list-style: none;
      padding: 12px 16px;
      background: #fff;
      border-bottom: 1px solid #e5e5ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
    }

    .text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .done {
      color: #8e8e93;
      text-decoration: line-through;
    }

    /* ===== 期限表示 ===== */
    .date-label {
      font-size: 13px;
      color: #8e8e93;
      cursor: pointer;
    }

    .date-label.due-today {
      color: #ff9500;
      font-weight: 600;
    }

    .date-label.overdue {
      color: #ff3b30;
      font-weight: 700;
    }

    .date-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .delete {
      background: none;
      border: none;
      font-size: 16px;
      color: #ff3b30;
    }

    @media (prefers-color-scheme: dark) {
      body { background: #000; color: #fff; }
      h2, .lists, .toolbar, .input-area, li { background: #1c1c1e; }
      li { border-bottom: 1px solid #2c2c2e; }
      input[type="text"], input[type="date"] {
        background: #2c2c2e;
        color: #fff;
        border: 1px solid #3a3a3c;
      }
    }
  </style>
</head>
<body>

<h2 id="title">チェックリスト</h2>

<div class="lists" id="lists"></div>

<div class="toolbar">
  <button onclick="backup()">バックアップ</button>
  <button onclick="restore()">復元</button>
  <button onclick="restoreAutoBackup()">自動復元</button>
</div>

<div class="input-area">
  <input id="itemInput" placeholder="新しい項目">
  <input id="dateInput" type="date">
  <button onclick="addItem()">追加</button>
</div>

<ul id="items"></ul>

<input id="fileInput" type="file" accept="application/json" style="display:none">

<script>
  let currentList = localStorage.getItem("currentList") || "default";

  function getLists() {
    return JSON.parse(localStorage.getItem("lists")) || {
      default: { name: "メイン", items: [] }
    };
  }

  function saveLists(lists) {
    localStorage.setItem("lists", JSON.stringify(lists));
  }

  function getDueStatus(date) {
    if (!date) return "";
    const today = new Date().toISOString().split("T")[0];
    if (date < today) return "overdue";
    if (date === today) return "due-today";
    return "";
  }

  function autoBackup() {
    localStorage.setItem("autoBackup", JSON.stringify({
      lists: getLists(),
      currentList
    }));
  }

  function showListMenu(id) {
      if (id === "default") {
        alert("このリストは削除できません");
        return;
      }

      const lists = getLists();

      const action = prompt(
        "操作を選んでください\n\n1：名前を変更\n2：削除"
      );

      if (action === "1") {
        const newName = prompt("新しいリスト名", lists[id].name);
        if (newName) {
          lists[id].name = newName;
          saveLists(lists);
          render();
        }
      }

      if (action === "2") {
        if (confirm("このリストを削除しますか？")) {
          delete lists[id];
          saveLists(lists);
          currentList = "default";
          localStorage.setItem("currentList", "default");
          render();
        }
      }
  }
  
  function renderLists() {
    const lists = getLists();
    const container = document.getElementById("lists");
    container.innerHTML = "";

    Object.keys(lists).forEach(id => {
      const btn = document.createElement("button");
      btn.textContent = lists[id].name;
      if (id === currentList) btn.classList.add("active");

      // 通常タップ：切り替え
      btn.onclick = () => {
        currentList = id;
        localStorage.setItem("currentList", id);
        render();
      };

      // 長押し：編集・削除
      let timer;
      btn.addEventListener("touchstart", () => {
        timer = setTimeout(() => showListMenu(id), 600);
      });
      btn.addEventListener("touchend", () => clearTimeout(timer));

      // PC / Safari対策（長押し）
      btn.addEventListener("mousedown", () => {
        timer = setTimeout(() => showListMenu(id), 600);
      });
      btn.addEventListener("mouseup", () => clearTimeout(timer));

      container.appendChild(btn);
    });

    const add = document.createElement("button");
    add.textContent = "＋";
    add.className = "add-list";
    add.onclick = () => {
      const name = prompt("リスト名");
      if (!name) return;
      const id = Date.now();
      const lists = getLists();
      lists[id] = { name, items: [] };
      saveLists(lists);
      currentList = id;
      localStorage.setItem("currentList", id);
      render();
    };
    container.appendChild(add);
  }

  function render() {
    autoBackup();

    const lists = getLists();
    const list = lists[currentList];
    if (!list) return;

    document.getElementById("title").textContent = list.name;

    list.items.sort((a, b) => {
      if (a.done !== b.done) return a.done - b.done;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return a.date.localeCompare(b.date);
    });

    const ul = document.getElementById("items");
    ul.innerHTML = "";

    list.items.forEach(item => {
      const dueClass = !item.done ? getDueStatus(item.date) : "";

      const li = document.createElement("li");
      li.innerHTML = `
        <div class="left">
          <input type="checkbox" ${item.done ? "checked" : ""}>
          <div class="text">
            <span class="${item.done ? "done" : ""}">${item.text}</span>
            <span class="date-label ${dueClass}">
              ${item.date || "期限を設定"}
            </span>
            <input type="date"
                   class="date-input"
                   value="${item.date || ""}">
          </div>
        </div>
        <button class="delete">削除</button>
      `;

      li.querySelector("input[type=checkbox]").onchange = () => {
        item.done = !item.done;
        saveLists(lists);
        render();
      };

      const dateInput = li.querySelector(".date-input");
      li.querySelector(".date-label").onclick = () => {
        dateInput.focus();

        // 空のときは showPicker を使わない（iOS対策）
        if (!dateInput.value) {
          dateInput.click();
          return;
        }

        if (dateInput.showPicker) {
          dateInput.showPicker();
        } else {
          dateInput.click();
        }
      };

      dateInput.onchange = e => {
        item.date = e.target.value;
        saveLists(lists);
        render();
      };

      li.querySelector(".delete").onclick = () => {
        list.items = list.items.filter(i => i.id !== item.id);
        saveLists(lists);
        render();
      };

      ul.appendChild(li);
    });

    renderLists();
  }

  function addItem() {
    if (!itemInput.value) return;

    const lists = getLists();
    lists[currentList].items.push({
      id: Date.now(),
      text: itemInput.value,
      date: dateInput.value,
      done: false
    });

    saveLists(lists);
    itemInput.value = "";
    dateInput.value = "";
    itemInput.blur();
    dateInput.blur();
    render();
  }

  function backup() {
    alert("次の画面で「ファイルに保存」→ iCloud Drive を選んでください");

    const blob = new Blob(
      [JSON.stringify({ lists: getLists(), currentList }, null, 2)],
      { type: "application/json" }
    );

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "checklist-backup-" +
      new Date().toISOString().split("T")[0] + ".json";
    a.click();
  }

  function restore() {
    if (!confirm("現在のデータは上書きされます。")) return;
    fileInput.click();
  }

  fileInput.onchange = e => {
    const reader = new FileReader();
    reader.onload = () => {
      const data = JSON.parse(reader.result);
      localStorage.setItem("lists", JSON.stringify(data.lists));
      localStorage.setItem("currentList", data.currentList || "default");
      location.reload();
    };
    reader.readAsText(e.target.files[0]);
  };

  function restoreAutoBackup() {
    const backup = localStorage.getItem("autoBackup");
    if (!backup) return alert("自動バックアップはありません");
    if (!confirm("自動バックアップから復元しますか？")) return;
    const data = JSON.parse(backup);
    localStorage.setItem("lists", JSON.stringify(data.lists));
    localStorage.setItem("currentList", data.currentList);
    location.reload();
  }

  render();
</script>

</body>
</html>
